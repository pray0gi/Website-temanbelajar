<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ujian Online - temanbelajar.my.id</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://css-proxy.vercel.app/api/fonts/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        [data-page] { display: none; }
        [data-page].active { display: block; }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .jawaban-radio:checked + label { border-color: #38bdf8; background-color: #0c4a6e; }
    </style>
</head>
<body class="bg-slate-900 text-white flex items-center justify-center min-h-screen p-4">

    <!-- Modal Peringatan Pelanggaran -->
    <div id="violation-warning" class="fixed inset-0 bg-black bg-opacity-95 flex-col items-center justify-center p-4 hidden z-50 text-center backdrop-blur-sm">
        <div class="bg-slate-800 p-8 rounded-xl border-2 border-red-500 shadow-2xl max-w-md animate-bounce">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-20 w-20 text-red-500 mx-auto mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
            </svg>
            <h2 class="text-3xl font-bold text-red-400 mb-2">PERINGATAN KERAS!</h2>
            <p class="text-lg text-white mb-4">Anda terdeteksi meninggalkan halaman ujian atau keluar dari mode layar penuh.</p>
            <div class="bg-red-900/30 p-4 rounded-lg mb-6 border border-red-900">
                <p class="text-slate-300">Sisa Kesempatan:</p>
                <p class="text-4xl font-bold text-white mt-1"><span id="violation-counter">6</span> / 6</p>
            </div>
            <p class="text-sm text-slate-400 mb-6">Jika kesempatan habis, jawaban akan otomatis dikirim dan Anda dianggap selesai.</p>
            <button id="close-warning-btn" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-8 rounded-lg transition transform hover:scale-105">KEMBALI KE UJIAN</button>
        </div>
    </div>

    <!-- Modal Umum -->
    <div id="custom-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-slate-800 p-8 rounded-xl shadow-2xl w-full max-w-md text-center">
            <h2 id="modal-title" class="text-2xl font-bold mb-4 text-sky-400"></h2>
            <p id="modal-message" class="text-slate-300 mb-6"></p>
            <div id="modal-buttons" class="flex justify-center space-x-4"></div>
        </div>
    </div>

    <div class="w-full max-w-4xl mx-auto">
        
        <!-- Login -->
        <div data-page="login" class="active fade-in">
            <div class="bg-slate-800 p-8 rounded-xl shadow-2xl max-w-md mx-auto">
                <h1 class="text-3xl font-bold text-center mb-6 text-sky-400">Login Siswa</h1>
                <form id="login-form">
                    <div class="mb-4">
                        <label class="block mb-2 text-sm text-slate-300">NIS</label>
                        <input type="text" id="nis" class="w-full bg-slate-700 p-3 rounded-lg border border-slate-600 focus:border-sky-500 outline-none" required>
                    </div>
                    <div class="mb-6">
                        <label class="block mb-2 text-sm text-slate-300">Password</label>
                        <input type="password" id="password" class="w-full bg-slate-700 p-3 rounded-lg border border-slate-600 focus:border-sky-500 outline-none" required>
                    </div>
                    <button id="login-btn" type="submit" class="w-full bg-sky-600 hover:bg-sky-700 text-white font-bold py-3 px-4 rounded-lg transition transform hover:scale-105">Masuk</button>
                    <p id="login-error" class="text-red-400 text-center text-sm mt-4 h-5"></p>
                </form>
            </div>
        </div>
        
        <!-- Dashboard Siswa -->
        <div data-page="select-mapel" class="fade-in">
            <div class="bg-slate-800 p-8 rounded-xl shadow-2xl">
                 <div class="flex justify-between items-center mb-8 border-b border-slate-700 pb-4">
                     <div>
                         <h1 class="text-2xl font-bold text-cyan-300">Halo, <span id="student-name-select"></span></h1>
                         <p class="text-slate-400 mt-1">Kelas: <span id="student-class-display" class="font-bold text-white"></span></p>
                     </div>
                     <button onclick="location.reload()" class="text-sm text-red-400 hover:text-red-300">Keluar</button>
                 </div>
                 
                 <div id="mapel-loading" class="text-center text-slate-500 py-10">Memeriksa jadwal ujian...</div>
                 <div id="mapel-list" class="grid grid-cols-1 gap-4 mt-4"></div>
                 <p id="no-exam-msg" class="text-center text-slate-500 hidden py-10">Tidak ada ujian aktif untuk kelas Anda saat ini.</p>
            </div>
        </div>

        <!-- Instruksi -->
        <div data-page="instructions" class="fade-in">
            <div class="bg-slate-800 p-8 rounded-xl shadow-2xl text-center">
                <h1 class="text-3xl font-bold mb-2 text-cyan-300"><span id="instruction-mapel-name"></span></h1>
                <h2 class="text-xl font-semibold mb-6 text-yellow-400" id="instruction-stage-name"></h2>
                <div class="bg-slate-900 p-6 rounded-lg text-left max-w-lg mx-auto mb-8 text-slate-300 border border-slate-700">
                    <p class="font-bold text-red-400 mb-2 uppercase text-center">‚ö†Ô∏è Peraturan Penting ‚ö†Ô∏è</p>
                    <ul class="list-disc list-inside space-y-3 text-sm">
                        <li>Jumlah soal: <strong id="total-questions-info" class="text-white"></strong></li>
                        <li>Durasi: <strong id="time-limit-info" class="text-white"></strong> menit</li>
                        <li>Wajib mengaktifkan <strong>Mode Layar Penuh (Fullscreen)</strong>.</li>
                        <li>Dilarang membuka tab lain, aplikasi lain, atau meminimalisir browser.</li>
                        <li><strong>Batas Pelanggaran: 6 Kali.</strong> Jika melanggar lebih dari 6 kali, jawaban akan otomatis terkirim.</li>
                    </ul>
                </div>
                <button id="start-exam-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-8 rounded-lg shadow-lg transition transform hover:scale-105">Saya Mengerti & Mulai</button>
                <button onclick="navigateTo('select-mapel')" class="block mt-4 mx-auto text-slate-400 hover:text-white text-sm underline">Batal</button>
            </div>
        </div>

        <!-- Ujian -->
        <div data-page="exam" class="fade-in">
             <div class="bg-slate-800 p-6 rounded-xl shadow-2xl min-h-screen md:min-h-0">
                <div class="flex justify-between items-center mb-6 border-b border-slate-700 pb-4 sticky top-0 bg-slate-800 z-20 pt-2">
                    <div>
                        <h1 class="text-lg md:text-xl font-bold text-cyan-300 line-clamp-1"><span id="exam-mapel-name"></span></h1>
                        <p class="text-xs text-slate-400" id="exam-stage-name"></p>
                    </div>
                    <div class="flex gap-2">
                        <div id="timer" class="bg-slate-900 text-white text-xl font-mono font-bold px-4 py-2 rounded-lg border border-slate-700 text-center">00:00</div>
                    </div>
                </div>
                <div id="exam-content" class="space-y-8 pb-20"></div>
                <div class="fixed bottom-0 left-0 w-full bg-slate-900 border-t border-slate-700 p-4 text-center z-20 md:relative md:bg-transparent md:border-0">
                    <button id="submit-exam-btn" class="bg-sky-600 hover:bg-sky-700 text-white font-bold py-3 px-12 rounded-lg shadow-lg transition transform hover:scale-105">Kirim Jawaban</button>
                </div>
            </div>
        </div>

        <!-- Selesai -->
        <div data-page="complete" class="fade-in">
            <div class="bg-slate-800 p-12 rounded-xl shadow-2xl text-center">
                <div class="text-6xl mb-4">üéâ</div>
                <h1 class="text-3xl font-bold mb-4 text-white">Ujian Selesai!</h1>
                <p class="text-slate-300 mb-2">Terima kasih, <span id="student-name-final" class="font-bold text-white"></span>.</p>
                <p id="completion-reason" class="text-slate-400 text-sm italic mb-6">Jawaban telah disimpan.</p>
                <button onclick="location.reload()" class="mt-4 bg-slate-700 hover:bg-slate-600 px-8 py-3 rounded-lg text-white font-semibold transition">Kembali ke Login</button>
            </div>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const SUPABASE_URL = 'https://mtadhiyfducemvckpnkb.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im10YWRoaXlmZHVjZW12Y2twbmtiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgxNjAwMjcsImV4cCI6MjA3MzczNjAyN30.BbjPW_FDSVN_cpf6uf3xXfZnl0fKgYi2rs-m8ytBWkk';
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    
    let siswaSaatIni = null;
    let configSaatIni = null;
    let soalUjian = [];
    let timerInterval = null;
    let jawabanSiswa = {};
    let WAKTU_UJIAN = 90;
    
    // VARIABEL KEAMANAN
    let violationCount = 0;
    const MAX_VIOLATIONS = 6;
    let isExamActive = false;
    
    // UI Helpers
    const showModal = (title, msg, buttons) => {
        document.getElementById('modal-title').textContent = title;
        document.getElementById('modal-message').textContent = msg;
        const btnContainer = document.getElementById('modal-buttons');
        btnContainer.innerHTML = '';
        buttons.forEach(b => {
            const btn = document.createElement('button');
            btn.className = b.class; btn.textContent = b.text; 
            btn.onclick = () => { document.getElementById('custom-modal').classList.add('hidden'); if(b.onClick) b.onClick(); };
            btnContainer.appendChild(btn);
        });
        document.getElementById('custom-modal').classList.remove('hidden');
    };

    const navigateTo = (page) => {
        document.querySelectorAll('[data-page]').forEach(el => el.classList.remove('active'));
        document.querySelector(`[data-page="${page}"]`).classList.add('active');
    };

    const getStageDisplayName = (stageKey) => {
        if(stageKey === 'ujian') return 'Ujian Tahap 1';
        return stageKey.replace(/_/g, ' ').toUpperCase();
    };

    // --- FUNGSI UTAMA SUBMIT (Didefinisikan sebagai Function agar Hoisted) ---
    async function submitExam(reason) {
        clearInterval(timerInterval);
        removeCheatingDetection(); // MATIKAN SISTEM KEAMANAN
        
        const btn = document.getElementById('submit-exam-btn');
        btn.disabled = true;
        btn.textContent = "Mengirim...";
        
        let correct = 0;
        soalUjian.forEach(q => {
            // Format key di jawabanSiswa adalah "soal-123"
            if (jawabanSiswa[`soal-${q.id}`] === q.jawaban_benar) correct++;
        });
        
        // Hitung Skor 0-100
        const score = soalUjian.length > 0 ? Math.round((correct / soalUjian.length) * 100) : 0;

        const payload = {
            nis_siswa: siswaSaatIni.nis,
            mapel_id: configSaatIni.mapel_id,
            jawaban_siswa: jawabanSiswa,
            skor_akhir: score
        };

        try {
            const { error } = await supabaseClient.from('hasil_ujian').insert([payload]);
            
            if (error) {
                throw error;
            }

            document.getElementById('student-name-final').textContent = siswaSaatIni.nama;
            document.getElementById('completion-reason').textContent = reason ? `Status: ${reason}` : "Jawaban berhasil disimpan.";
            navigateTo('complete');
            if(document.fullscreenElement) document.exitFullscreen().catch(()=>{});

        } catch (err) {
            console.error("Gagal Submit:", err);
            alert("Gagal menyimpan nilai. Periksa koneksi internet Anda dan coba lagi.");
            btn.disabled = false;
            btn.textContent = "Kirim Jawaban";
        }
    };

    // --- LOGIKA KEAMANAN (ANTI-CHEAT) ---
    const setupCheatingDetection = () => {
        violationCount = 0;
        isExamActive = true;
        document.getElementById('violation-counter').textContent = MAX_VIOLATIONS;

        document.addEventListener('visibilitychange', handleVisibilityChange);
        document.addEventListener('fullscreenchange', handleFullscreenChange);
        document.addEventListener('webkitfullscreenchange', handleFullscreenChange);
    };

    const removeCheatingDetection = () => {
        isExamActive = false;
        document.removeEventListener('visibilitychange', handleVisibilityChange);
        document.removeEventListener('fullscreenchange', handleFullscreenChange);
        document.removeEventListener('webkitfullscreenchange', handleFullscreenChange);
    };

    const handleVisibilityChange = () => {
        if (document.hidden && isExamActive) {
            triggerViolation();
        }
    };

    const handleFullscreenChange = () => {
        if (!document.fullscreenElement && !document.webkitFullscreenElement && isExamActive) {
            triggerViolation();
        }
    };

    const triggerViolation = () => {
        if (!isExamActive) return;
        
        violationCount++;
        const remaining = MAX_VIOLATIONS - violationCount;
        document.getElementById('violation-counter').textContent = remaining;
        
        const warningModal = document.getElementById('violation-warning');
        warningModal.classList.remove('hidden');
        warningModal.classList.add('flex');

        if (violationCount >= MAX_VIOLATIONS) {
            isExamActive = false; 
            document.getElementById('close-warning-btn').disabled = true;
            document.getElementById('close-warning-btn').textContent = "DISKUALIFIKASI...";
            setTimeout(() => {
                warningModal.classList.add('hidden');
                // Kirim jawaban apa adanya jika melanggar 6x
                submitExam("Diskualifikasi (Batas Pelanggaran Habis)");
            }, 2000);
        }
    };

    document.getElementById('close-warning-btn').addEventListener('click', () => {
        if (violationCount < MAX_VIOLATIONS) {
            document.getElementById('violation-warning').classList.add('hidden');
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(e => console.log(e));
            }
        }
    });


    // --- LOGIKA UTAMA: PEMILIHAN UJIAN DINAMIS ---
    const showMapelSelection = async () => {
        const loadingEl = document.getElementById('mapel-loading');
        const listEl = document.getElementById('mapel-list');
        const noExamMsg = document.getElementById('no-exam-msg');
        
        loadingEl.classList.remove('hidden');
        listEl.innerHTML = '';
        noExamMsg.classList.add('hidden');

        try {
            const { data: mapels } = await supabaseClient.from('mata_pelajaran').select('*');
            
            const { data: configs } = await supabaseClient
                .from('pengaturan_ujian')
                .select('*')
                .eq('is_active', true);

            const { data: history } = await supabaseClient
                .from('hasil_ujian')
                .select('mapel_id, jawaban_siswa, skor_akhir')
                .eq('nis_siswa', siswaSaatIni.nis);

            const { data: allQuestions } = await supabaseClient.from('soal_ujian').select('id, jenis_soal');
            const qStageMap = {};
            allQuestions?.forEach(q => qStageMap[q.id] = q.jenis_soal || 'ujian');

            // LOGIKA BARU: MENGELOMPOKKAN RIWAYAT PER TAHAP
            const historyStats = {}; 
            
            history?.forEach(h => {
                const firstQKey = Object.keys(h.jawaban_siswa)[0]; 
                if(firstQKey) {
                    const qId = parseInt(firstQKey.split('-')[1]);
                    const stage = qStageMap[qId] || 'ujian';
                    const key = `${h.mapel_id}_${stage}`;
                    
                    if(!historyStats[key]) {
                        historyStats[key] = { count: 0, maxScore: 0 };
                    }
                    
                    historyStats[key].count++;
                    // Cari skor tertinggi
                    if(h.skor_akhir > historyStats[key].maxScore) {
                        historyStats[key].maxScore = h.skor_akhir;
                    }
                    // Jika ini percobaan terbaru, update lastScore (bisa ditambahkan jika perlu)
                }
            });

            let hasExam = false;
            const studentClass = (siswaSaatIni.kelas || "").toLowerCase().trim();

            mapels.forEach(mapel => {
                const mapelConfigs = configs.filter(c => c.mapel_id === mapel.id);
                
                const validConfigs = mapelConfigs.filter(cfg => {
                    const target = (cfg.kelas_target || 'semua').toLowerCase();
                    if (target.includes('semua')) return true;
                    const targets = target.split(',').map(t => t.trim());
                    return targets.includes(studentClass);
                });

                if (validConfigs.length > 0) {
                    hasExam = true;
                    const card = document.createElement('div');
                    card.className = 'bg-slate-700 p-6 rounded-lg border border-slate-600 transition hover:border-sky-500';
                    
                    let html = `<h3 class="text-xl font-bold text-white mb-4 flex items-center gap-2">${mapel.nama_mapel}</h3>`;
                    html += `<div class="grid grid-cols-1 md:grid-cols-2 gap-3">`;

                    validConfigs.sort((a,b) => {
                        if(a.jenis_soal === 'ujian') return -1;
                        if(b.jenis_soal === 'ujian') return 1;
                        return a.jenis_soal.localeCompare(b.jenis_soal);
                    });

                    validConfigs.forEach(cfg => {
                        const key = `${mapel.id}_${cfg.jenis_soal}`;
                        const stats = historyStats[key] || { count: 0, maxScore: 0 };
                        const displayName = getStageDisplayName(cfg.jenis_soal);

                        // --- LOGIKA TAMPILAN TOMBOL BERDASARKAN RIWAYAT ---
                        // KONDISI 1: Belum pernah mengerjakan (0 kali) -> BOLEH
                        if (stats.count === 0) {
                            const configStr = encodeURIComponent(JSON.stringify(cfg));
                            html += `
                            <button onclick="prepareExam('${configStr}', '${mapel.nama_mapel}')" 
                                class="flex justify-between items-center bg-sky-600 hover:bg-sky-500 text-white p-3 rounded font-semibold transition shadow-lg group text-left">
                                <div>
                                    <span class="block text-sm font-bold">${displayName}</span>
                                    <span class="text-xs font-normal opacity-75">${cfg.durasi_menit} Menit</span>
                                </div>
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 transform group-hover:translate-x-1 transition" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6" /></svg>
                            </button>`;
                        }
                        // KONDISI 2: Sudah 1 kali DAN Nilai < 75 -> BOLEH (Remedial)
                        else if (stats.count === 1 && stats.maxScore < 75) {
                            const configStr = encodeURIComponent(JSON.stringify(cfg));
                            html += `
                            <button onclick="prepareExam('${configStr}', '${mapel.nama_mapel}')" 
                                class="flex justify-between items-center bg-yellow-600 hover:bg-yellow-500 text-white p-3 rounded font-semibold transition shadow-lg group text-left border border-yellow-400">
                                <div>
                                    <span class="block text-sm font-bold text-yellow-100">Remedial ${displayName}</span>
                                    <span class="text-xs font-normal text-yellow-200">Nilai Sebelumnya: ${stats.maxScore} (Belum Tuntas)</span>
                                </div>
                                <span class="bg-yellow-100 text-yellow-800 text-xs font-bold px-2 py-1 rounded">Ulangi</span>
                            </button>`;
                        }
                        // KONDISI 3: Sudah >= 2 kali ATAU Nilai >= 75 -> SELESAI
                        else {
                            let statusText = stats.maxScore >= 75 ? "Tuntas" : "Kesempatan Habis";
                            let scoreColor = stats.maxScore >= 75 ? 'text-green-400 border-green-800 bg-green-900/30' : 'text-red-400 border-red-800 bg-red-900/30';
                            
                            html += `
                            <div class="flex justify-between items-center p-3 rounded border ${scoreColor}">
                                <div>
                                    <div class="text-xs font-bold uppercase opacity-80">${displayName}</div>
                                    <div class="text-xs mt-1">${statusText}</div>
                                </div>
                                <div class="text-2xl font-bold">${stats.maxScore}</div>
                            </div>`;
                        }
                    });

                    html += `</div>`;
                    card.innerHTML = html;
                    listEl.appendChild(card);
                }
            });

            if (!hasExam) noExamMsg.classList.remove('hidden');

        } catch (e) {
            console.error(e);
            listEl.innerHTML = `<p class="text-red-400 text-center">Gagal memuat data ujian. Silakan refresh.</p>`;
        } finally {
            loadingEl.classList.add('hidden');
        }
        navigateTo('select-mapel');
    };

    window.prepareExam = async (configStr, mapelName) => {
        configSaatIni = JSON.parse(decodeURIComponent(configStr));
        WAKTU_UJIAN = configSaatIni.durasi_menit || 90;
        
        const { count } = await supabaseClient.from('soal_ujian')
            .select('*', { count: 'exact', head: true })
            .eq('mapel_id', configSaatIni.mapel_id)
            .eq('jenis_soal', configSaatIni.jenis_soal);

        if (!count || count === 0) {
            alert("Maaf, soal untuk ujian ini belum tersedia/kosong.");
            return;
        }

        const stageLabel = getStageDisplayName(configSaatIni.jenis_soal);
        
        document.getElementById('instruction-mapel-name').textContent = mapelName;
        document.getElementById('instruction-stage-name').textContent = stageLabel;
        document.getElementById('total-questions-info').textContent = count;
        document.getElementById('time-limit-info').textContent = WAKTU_UJIAN;
        
        configSaatIni.nama_mapel = mapelName;
        navigateTo('instructions');
    };

    document.getElementById('login-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const nis = document.getElementById('nis').value;
        const pass = document.getElementById('password').value;
        const btn = document.getElementById('login-btn');
        
        btn.disabled = true; btn.textContent = 'Memuat...';
        
        const { data: siswa, error } = await supabaseClient.from('siswa').select('*').eq('nis', nis).single();
        
        if (siswa && siswa.password === pass) {
            siswaSaatIni = siswa;
            document.getElementById('student-name-select').textContent = siswa.nama;
            document.getElementById('student-class-display').textContent = siswa.kelas || "-";
            showMapelSelection();
        } else {
            document.getElementById('login-error').textContent = 'NIS atau Password salah.';
            btn.disabled = false; btn.textContent = 'Masuk';
        }
    });

    // MULAI UJIAN
    document.getElementById('start-exam-btn').addEventListener('click', async () => {
        const el = document.documentElement;
        try {
            if (el.requestFullscreen) await el.requestFullscreen();
            else if (el.webkitRequestFullscreen) await el.webkitRequestFullscreen();
            else if (el.msRequestFullscreen) await el.msRequestFullscreen();
        } catch (err) {
            console.log("Fullscreen blocked/not supported");
        }

        loadExamQuestions();
    });

    async function loadExamQuestions() {
        const { data } = await supabaseClient.from('soal_ujian')
            .select('id, pertanyaan, pilihan, jawaban_benar, url_gambar')
            .eq('mapel_id', configSaatIni.mapel_id)
            .eq('jenis_soal', configSaatIni.jenis_soal);

        if(!data || data.length === 0) {
            alert("Soal belum tersedia.");
            return;
        }

        soalUjian = data.sort(() => Math.random() - 0.5);
        jawabanSiswa = {};
        
        renderExamUI();
        startTimer(WAKTU_UJIAN);
        setupCheatingDetection(); 
        navigateTo('exam');
    }

    function renderExamUI() {
        document.getElementById('exam-mapel-name').textContent = configSaatIni.nama_mapel;
        document.getElementById('exam-stage-name').textContent = getStageDisplayName(configSaatIni.jenis_soal);
        
        const container = document.getElementById('exam-content');
        container.innerHTML = '';

        soalUjian.forEach((q, idx) => {
            const el = document.createElement('div');
            el.className = 'bg-slate-700/50 p-4 rounded-lg border border-slate-600';
            
            let img = q.url_gambar ? `<img src="${q.url_gambar}" class="max-h-64 mx-auto my-4 rounded-lg shadow-md">` : '';
            
            let options = `<div class="grid grid-cols-1 gap-3 mt-4">`;
            q.pilihan.forEach(opt => {
                options += `
                <label class="flex items-center p-3 bg-slate-800 rounded border border-slate-600 cursor-pointer hover:bg-slate-700 transition">
                    <input type="radio" name="soal-${q.id}" value="${opt}" class="w-5 h-5 text-sky-600 bg-slate-900 border-slate-500 focus:ring-sky-500">
                    <span class="ml-3 text-slate-200">${opt}</span>
                </label>`;
            });
            options += `</div>`;

            el.innerHTML = `
                <div class="flex gap-3">
                    <span class="bg-sky-900 text-sky-200 h-8 w-8 flex items-center justify-center rounded font-bold text-sm shrink-0">${idx+1}</span>
                    <div class="w-full">
                        <p class="text-lg text-white font-medium">${q.pertanyaan}</p>
                        ${img}
                        ${options}
                    </div>
                </div>
            `;
            container.appendChild(el);
        });

        container.addEventListener('change', (e) => {
            if(e.target.type === 'radio') {
                jawabanSiswa[e.target.name] = e.target.value;
            }
        });
    }

    function startTimer(minutes) {
        let time = minutes * 60;
        const display = document.getElementById('timer');
        
        if (timerInterval) clearInterval(timerInterval);
        
        timerInterval = setInterval(() => {
            const m = Math.floor(time / 60);
            const s = time % 60;
            display.textContent = `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
            
            if (time <= 300) { 
                display.classList.remove('bg-red-900', 'text-red-100');
                display.classList.add('bg-yellow-500', 'text-black', 'animate-pulse');
            }

            if (time <= 0) {
                submitExam("Waktu Habis"); // Auto submit
            }
            time--;
        }, 1000);
    }

    // --- LOGIKA VALIDASI TOMBOL KIRIM ---
    document.getElementById('submit-exam-btn').addEventListener('click', () => {
        const filled = Object.keys(jawabanSiswa).length;
        const total = soalUjian.length;

        if (filled < total) {
            showModal('Peringatan', `Anda baru menjawab ${filled} dari ${total} soal. Harap jawab semua soal sebelum mengirim.`, [
                { text: 'OK, Saya Mengerti', class: 'bg-sky-600 hover:bg-sky-500 text-white py-2 px-6 rounded font-bold', onClick: null }
            ]);
            return; 
        }
        
        showModal('Konfirmasi', 'Semua soal telah terisi. Yakin ingin mengirim jawaban?', [
            { text: 'Periksa Lagi', class: 'bg-slate-600 hover:bg-slate-500 text-white py-2 px-4 rounded', onClick: null },
            { text: 'Ya, Kirim', class: 'bg-green-600 hover:bg-green-500 text-white py-2 px-4 rounded font-bold', onClick: () => submitExam("Selesai Normal") }
        ]);
    });
    
    document.getElementById('close-warning-btn').addEventListener('click', () => {
        document.getElementById('violation-warning').classList.add('hidden');
    });
});
</script>
</body>
</html>
