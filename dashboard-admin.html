<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Guru - temanbelajar.my.id</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://css-proxy.vercel.app/api/fonts/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/docx@8.2.1/build/index.umd.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        [data-page], [data-view] { display: none; }
        [data-page].active, [data-view].active { display: block; }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .nav-btn.active { background-color: #0ea5e9; color: white; }
        /* Custom Scrollbar for list */
        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #1e293b; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #64748b; }
        /* Toggle Switch Style */
        .toggle-checkbox:checked {
            right: 0;
            border-color: #68D391;
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: #68D391;
        }
    </style>
</head>
<body class="bg-slate-900 text-white min-h-screen">

    <!-- Halaman Login Admin -->
    <div data-page="login" class="active">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-slate-800 p-8 rounded-xl shadow-2xl max-w-md w-full fade-in">
                <h1 class="text-3xl font-bold text-center mb-6 text-sky-400">Admin Login</h1>
                <form id="admin-login-form">
                    <div class="mb-4">
                        <label for="username" class="block mb-2 text-sm font-medium text-slate-300">Username</label>
                        <input type="text" id="username" class="w-full bg-slate-700 p-3 rounded-lg border border-slate-600 focus:ring-2 focus:ring-sky-500 focus:outline-none" required>
                    </div>
                    <div class="mb-6">
                        <label for="admin-password" class="block mb-2 text-sm font-medium text-slate-300">Password</label>
                        <input type="password" id="admin-password" class="w-full bg-slate-700 p-3 rounded-lg border border-slate-600 focus:ring-2 focus:ring-sky-500 focus:outline-none" required>
                    </div>
                    <button id="login-submit-btn" type="submit" class="w-full bg-sky-600 hover:bg-sky-700 text-white font-bold py-3 px-4 rounded-lg transition-transform duration-200 hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed">Masuk</button>
                    <p id="admin-login-error" class="text-red-400 text-center text-sm mt-4 min-h-[20px]"></p>
                </form>
            </div>
        </div>
    </div>

    <!-- Halaman Dashboard Utama -->
    <div data-page="dashboard" class="fade-in">
        <header class="bg-slate-800 p-4 flex justify-between items-center shadow-md sticky top-0 z-50">
            <div class="flex items-center gap-4">
                <h1 class="text-xl font-bold text-sky-400">Dashboard Guru</h1>
                <button id="refresh-data-btn" class="bg-slate-700 hover:bg-slate-600 text-white font-semibold py-2 px-4 rounded-lg text-sm flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h5M20 20v-5h-5M20 4h-5v5M4 20h5v-5"/></svg>
                    <span>Refresh Data</span>
                </button>
            </div>
            <button id="logout-btn" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg text-sm">Logout</button>
        </header>

        <main class="p-4 md:p-8">
            <nav class="flex space-x-2 md:space-x-4 mb-6 bg-slate-800 p-2 rounded-lg overflow-x-auto">
                <button data-target="analitik" class="nav-btn flex-1 py-2 px-4 rounded-md font-semibold transition-colors whitespace-nowrap active">Analitik</button>
                <button data-target="publikasi" class="nav-btn flex-1 py-2 px-4 rounded-md font-semibold transition-colors whitespace-nowrap bg-purple-900/30 text-purple-200 border border-purple-500/30 hover:bg-purple-900/50">Publikasi Ujian</button>
                <button data-target="siswa" class="nav-btn flex-1 py-2 px-4 rounded-md font-semibold transition-colors whitespace-nowrap">Manajemen Siswa</button>
                <button data-target="soal" class="nav-btn flex-1 py-2 px-4 rounded-md font-semibold transition-colors whitespace-nowrap">Bank Soal</button>
                <button data-target="hasil" class="nav-btn flex-1 py-2 px-4 rounded-md font-semibold transition-colors whitespace-nowrap">Hasil Ujian</button>
                <button data-target="latihan" class="nav-btn flex-1 py-2 px-4 rounded-md font-semibold transition-colors whitespace-nowrap">Hasil Latihan</button>
            </nav>

            <!-- VIEW ANALITIK -->
            <div data-view="analitik" class="active">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-2 bg-slate-800 p-6 rounded-xl">
                        <h2 class="text-2xl font-bold mb-4 text-cyan-300">Rata-rata Nilai per Mata Pelajaran</h2>
                        <div class="bg-slate-900 p-4 rounded-lg">
                            <canvas id="average-score-chart"></canvas>
                        </div>
                    </div>
                    <div class="bg-slate-800 p-6 rounded-xl">
                        <h2 class="text-2xl font-bold mb-4 text-cyan-300">5 Butir Soal Tersulit</h2>
                        <div id="difficult-questions-list" class="space-y-4">
                            <p class="text-slate-500">Menganalisis data...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- VIEW PUBLIKASI -->
            <div data-view="publikasi">
                <div class="bg-slate-800 p-6 rounded-xl border border-purple-500/30 shadow-lg">
                    <div class="flex flex-col md:flex-row justify-between items-start mb-6 gap-4">
                        <div>
                            <h2 class="text-2xl font-bold text-purple-300">Pengaturan Publikasi Ujian</h2>
                            <p class="text-sm text-slate-400 mt-1">Atur ujian mana yang aktif, durasi, dan target kelas.</p>
                        </div>
                        <button id="btn-add-config" class="bg-purple-600 hover:bg-purple-500 text-white font-bold py-2 px-6 rounded-lg shadow-lg flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                            Atur Ujian Baru
                        </button>
                    </div>

                    <div class="overflow-x-auto rounded-lg border border-slate-700">
                        <table class="w-full text-left">
                            <thead class="bg-slate-700 text-slate-300 text-sm uppercase">
                                <tr>
                                    <th class="p-4">Mata Pelajaran</th>
                                    <th class="p-4">Tahap Ujian</th>
                                    <th class="p-4">Target Kelas</th>
                                    <th class="p-4">Durasi</th>
                                    <th class="p-4">Status</th>
                                    <th class="p-4 text-right">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="config-table-body" class="bg-slate-800 text-sm divide-y divide-slate-700">
                                <tr><td colspan="6" class="p-8 text-center text-slate-500">Memuat data pengaturan...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- VIEW SISWA -->
            <div data-view="siswa">
                <div class="bg-slate-800 p-6 rounded-xl">
                    <div class="flex flex-col md:flex-row justify-between items-start mb-4">
                        <div>
                            <h2 class="text-2xl font-bold text-cyan-300 mb-2">Daftar Siswa</h2>
                            <div class="flex items-center gap-2">
                                <label for="filter-siswa-mapel" class="text-sm">Lihat status untuk mapel:</label>
                                <select id="filter-siswa-mapel" class="bg-slate-700 text-white p-2 rounded-md text-sm"></select>
                            </div>
                        </div>
                        <button id="delete-selected-siswa-btn" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg hidden flex items-center gap-2 mt-4 md:mt-0">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                            Hapus Siswa Terpilih
                        </button>
                    </div>
                    <div class="flex flex-wrap gap-4 mb-4">
                        <button id="download-siswa-template" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg">Download Template CSV</button>
                        <input type="file" id="upload-siswa-csv" class="hidden" accept=".csv">
                        <label for="upload-siswa-csv" class="bg-sky-600 hover:bg-sky-700 text-white font-semibold py-2 px-4 rounded-lg cursor-pointer">Upload CSV Siswa</label>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead class="bg-slate-700">
                                <tr>
                                    <th class="p-3 w-4"><input type="checkbox" id="select-all-siswa" class="rounded bg-slate-600 border-slate-500 focus:ring-sky-500 cursor-pointer"></th>
                                    <th class="p-3">NIS</th>
                                    <th class="p-3">Nama</th>
                                    <th class="p-3">Kelas</th>
                                    <th class="p-3">Status</th>
                                    <th class="p-3 text-right">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="siswa-table-body" class="bg-slate-800"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- VIEW SOAL -->
            <div data-view="soal">
                <div class="bg-slate-800 p-6 rounded-xl">
                    <div class="flex flex-col xl:flex-row justify-between items-start mb-6 gap-4">
                        <div class="w-full xl:w-auto">
                            <h2 class="text-2xl font-bold text-cyan-300 mb-3">Bank Soal Ujian</h2>
                            <div class="flex flex-col sm:flex-row gap-3 bg-slate-900 p-3 rounded-lg border border-slate-700">
                                <div class="flex flex-col">
                                    <label for="filter-mapel" class="text-xs text-slate-400 mb-1">Mata Pelajaran</label>
                                    <select id="filter-mapel" class="bg-slate-700 text-white p-2 rounded-md text-sm border border-slate-600 focus:ring-1 focus:ring-sky-500 outline-none">
                                        <option value="all">Semua Mata Pelajaran</option>
                                    </select>
                                </div>
                                <div class="flex flex-col">
                                    <label for="filter-jenis-soal" class="text-xs text-slate-400 mb-1">Tahap Ujian (Dinamis)</label>
                                    <select id="filter-jenis-soal" class="bg-slate-700 text-white p-2 rounded-md text-sm border border-slate-600 focus:ring-1 focus:ring-sky-500 outline-none">
                                        <!-- Opsi diisi otomatis -->
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="flex flex-wrap gap-2 items-center">
                            <button id="btn-open-create-soal" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                                Buat Soal
                            </button>
                            <button id="btn-open-import-modal" class="bg-purple-600 hover:bg-purple-700 text-white font-semibold py-2 px-4 rounded-lg flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7v8a2 2 0 002 2h6M8 7V5a2 2 0 012-2h4.586a1 1 0 011.414.414l4.414 4.414a1 1 0 01.414 1.414V15a2 2 0 01-2 2h-2M8 7H6a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2v-2" /></svg>
                                Salin dari Tahap Lain
                            </button>
                            <!-- TOMBOL HAPUS MASSAL SOAL -->
                            <button id="delete-selected-soal-btn" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg hidden flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                                Hapus Terpilih
                            </button>
                        </div>
                    </div>

                    <div class="flex flex-wrap gap-3 mb-4 pt-4 border-t border-slate-700">
                        <button id="download-soal-template" class="bg-slate-600 hover:bg-slate-500 text-white font-semibold py-2 px-4 rounded-lg text-sm">Download Template CSV</button>
                        <button id="download-soal-docx" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg text-sm">Download DOCX</button>
                        <input type="file" id="upload-soal-csv" class="hidden" accept=".csv,.txt">
                        <label for="upload-soal-csv" class="bg-sky-600 hover:bg-sky-700 text-white font-semibold py-2 px-4 rounded-lg cursor-pointer text-sm">Upload CSV ke Tahap Ini</label>
                    </div>

                    <div class="overflow-x-auto rounded-lg border border-slate-700">
                        <table class="w-full text-left">
                            <thead class="bg-slate-700 text-slate-300 text-sm uppercase">
                                <tr>
                                    <th class="p-3 w-4"><input type="checkbox" id="select-all-soal" class="rounded bg-slate-600 border-slate-500 focus:ring-sky-500 cursor-pointer"></th>
                                    <th class="p-3 w-16">ID</th>
                                    <th class="p-3">Mapel</th>
                                    <th class="p-3 w-32">Tahap</th>
                                    <th class="p-3">Pertanyaan</th>
                                    <th class="p-3 w-16">Img</th>
                                    <th class="p-3 w-16 text-center">Kunci</th>
                                    <th class="p-3 w-32">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="soal-table-body" class="bg-slate-800 text-sm divide-y divide-slate-700"></tbody>
                        </table>
                    </div>
                    <div id="empty-state-soal" class="hidden text-center py-10 text-slate-500">
                        Tidak ada soal untuk mata pelajaran dan tahap ini.
                    </div>
                </div>
            </div>
            
            <!-- VIEW HASIL -->
            <div data-view="hasil">
                <div class="bg-slate-800 p-6 rounded-xl">
                    <div class="flex flex-col md:flex-row justify-between items-start mb-4 gap-4">
                           <h2 class="text-2xl font-bold text-cyan-300 mb-2">Hasil Pengerjaan Ujian</h2>
                           <div class="flex items-center gap-2">
                                <div class="flex flex-col">
                                    <label for="filter-hasil-mapel" class="text-xs text-slate-400 mb-1">Mata Pelajaran</label>
                                    <select id="filter-hasil-mapel" class="bg-slate-700 text-white p-2 rounded-md text-sm border border-slate-600 focus:ring-1 focus:ring-sky-500">
                                         <option value="all">Semua Mata Pelajaran</option>
                                    </select>
                                </div>
                                <div class="flex flex-col">
                                    <label for="filter-hasil-jenis" class="text-xs text-slate-400 mb-1">Tahap Ujian</label>
                                    <select id="filter-hasil-jenis" class="bg-slate-700 text-white p-2 rounded-md text-sm border border-slate-600 focus:ring-1 focus:ring-sky-500">
                                         <option value="all">Semua Tahap</option>
                                    </select>
                                </div>
                            </div>
                    </div>
                    <button id="download-hasil" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg mb-4 text-sm">Download Hasil (CSV)</button>
                       <div class="overflow-x-auto rounded-lg border border-slate-700">
                            <table class="w-full text-left">
                                <thead class="bg-slate-700 text-slate-300 text-sm uppercase">
                                    <tr>
                                        <th class="p-3">Waktu</th>
                                        <th class="p-3">NIS</th>
                                        <th class="p-3">Nama Siswa</th>
                                        <th class="p-3">Mata Pelajaran</th>
                                        <th class="p-3">Tahap</th>
                                        <th class="p-3">Skor</th>
                                        <th class="p-3">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="hasil-table-body" class="bg-slate-800 text-sm divide-y divide-slate-700"></tbody>
                            </table>
                       </div>
                </div>
            </div>

            <div data-view="latihan">
                <div class="bg-slate-800 p-6 rounded-xl">
                    <div class="flex flex-col md:flex-row justify-between items-start mb-4">
                           <h2 class="text-2xl font-bold text-cyan-300 mb-2">Laporan Hasil Latihan Siswa</h2>
                           <div class="flex items-center gap-2">
                                <label for="filter-latihan-mapel" class="text-sm">Filter:</label>
                                <select id="filter-latihan-mapel" class="bg-slate-700 text-white p-2 rounded-md text-sm">
                                     <option value="all">Semua Mata Pelajaran</option>
                                </select>
                            </div>
                    </div>
                    <button id="download-latihan" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg mb-4">Download Hasil Latihan (CSV)</button>
                       <div class="overflow-x-auto">
                            <table class="w-full text-left">
                                <thead class="bg-slate-700">
                                    <tr>
                                        <th class="p-3">NIS</th>
                                        <th class="p-3">Nama Siswa</th>
                                        <th class="p-3">Mata Pelajaran</th>
                                        <th class="p-3">Skor Awal</th>
                                        <th class="p-3">Skor Akhir</th>
                                        <th class="p-3">Rata-rata</th>
                                    </tr>
                                </thead>
                                <tbody id="latihan-table-body" class="bg-slate-800"></tbody>
                            </table>
                       </div>
                </div>
            </div>
        </main>
    </div>

    <!-- MODAL UMUM -->
    <div id="custom-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-slate-800 p-8 rounded-xl shadow-2xl w-full max-w-md fade-in text-center">
            <h2 id="modal-title" class="text-2xl font-bold mb-4 text-sky-400"></h2>
            <p id="modal-message" class="text-slate-300 mb-6"></p>
            <div id="modal-buttons" class="flex justify-center space-x-4"></div>
        </div>
    </div>

    <!-- MODAL CONFIG PUBLIKASI -->
    <div id="config-modal" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-slate-800 p-8 rounded-xl shadow-2xl w-full max-w-lg fade-in border border-purple-500/50 max-h-[90vh] overflow-y-auto">
            <h2 class="text-2xl font-bold mb-6 text-purple-300">Atur Publikasi Ujian</h2>
            <form id="config-form" class="space-y-4">
                <input type="hidden" id="config-id">
                
                <div>
                    <label class="block text-sm mb-1 text-slate-300">Mata Pelajaran</label>
                    <select id="config-mapel" class="w-full bg-slate-700 p-2 rounded border border-slate-600 focus:border-purple-500 outline-none" required></select>
                </div>

                <div>
                    <label class="block text-sm mb-1 text-slate-300">Tahap Ujian</label>
                    <select id="config-stage" class="w-full bg-slate-700 p-2 rounded border border-slate-600 focus:border-purple-500 outline-none">
                        <!-- Diisi JS -->
                    </select>
                    <input type="text" id="config-stage-new" class="w-full bg-slate-700 p-2 rounded border border-slate-600 mt-2 hidden" placeholder="Nama Tahap Baru (contoh: UAS Ganjil)">
                </div>

                <div>
                    <label class="block text-sm mb-1 text-slate-300">Target Kelas</label>
                    <input type="text" id="config-kelas" class="w-full bg-slate-700 p-2 rounded border border-slate-600 focus:border-purple-500 outline-none" placeholder="Contoh: 10A, 10B, 11 IPA 1 (Pisahkan koma)" required>
                    <p class="text-xs text-slate-500 mt-1">*Tulis 'Semua' untuk semua kelas.</p>
                </div>

                <div>
                    <label class="block text-sm mb-1 text-slate-300">Durasi (Menit)</label>
                    <input type="number" id="config-durasi" class="w-full bg-slate-700 p-2 rounded border border-slate-600 focus:border-purple-500 outline-none" value="90" required>
                </div>

                <div class="flex items-center space-x-3 pt-2 bg-slate-700/30 p-3 rounded border border-slate-600/50">
                    <input type="checkbox" id="config-active" class="w-5 h-5 rounded bg-slate-700 border-slate-600 text-purple-600 focus:ring-purple-500 cursor-pointer">
                    <label for="config-active" class="text-sm font-bold text-slate-200 cursor-pointer select-none">Aktifkan Ujian (Tampil di Siswa)</label>
                </div>

                <div class="flex justify-end gap-3 pt-4 border-t border-slate-700 mt-4">
                    <button type="button" onclick="document.getElementById('config-modal').classList.add('hidden')" class="px-4 py-2 bg-slate-600 rounded text-white">Batal</button>
                    <button type="submit" class="px-6 py-2 bg-purple-600 hover:bg-purple-700 rounded text-white font-bold">Simpan Pengaturan</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal Edit/Buat Soal -->
    <div id="edit-soal-modal" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-slate-800 p-8 rounded-xl shadow-2xl w-full max-w-3xl fade-in max-h-[90vh] overflow-y-auto border border-slate-600">
            <h2 id="form-title" class="text-2xl font-bold mb-6 text-cyan-300">Edit Soal</h2>
            <form id="edit-soal-form">
                <input type="hidden" id="edit-soal-id">
                <input type="hidden" id="edit-soal-image-path">
                <div class="flex flex-col md:flex-row gap-6">
                    <div class="flex-shrink-0 w-full md:w-1/3">
                        <div class="mb-4">
                            <label class="block mb-2 text-sm font-medium">Gambar</label>
                            <div class="relative group">
                                <img id="image-preview" src="https://placehold.co/150x100/1e293b/94a3b8?text=Tidak+Ada" alt="Preview" class="w-full h-40 object-cover rounded-lg bg-slate-700 border border-slate-600">
                                <div class="absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center opacity-0 group-hover:opacity-100 transition rounded-lg">
                                    <label for="image-upload" class="cursor-pointer text-white text-sm hover:underline">Ganti Gambar</label>
                                </div>
                            </div>
                            <input type="file" id="image-upload" class="hidden" accept="image/png, image/jpeg, image/gif">
                            <div class="mt-2 text-right">
                                <button type="button" id="remove-image-btn" class="text-xs text-red-400 hover:text-red-300">Hapus Gambar</button>
                            </div>
                        </div>
                        <div class="mb-4">
                            <label for="edit-mapel" class="block mb-1 text-sm font-medium">Mapel</label>
                            <select id="edit-mapel" class="w-full bg-slate-700 p-2 rounded border border-slate-600 text-sm" required></select>
                        </div>
                        <div class="mb-4">
                            <label for="edit-jenis-soal" class="block mb-1 text-sm font-medium">Tahap Ujian</label>
                            <select id="edit-jenis-soal" class="w-full bg-slate-700 p-2 rounded border border-slate-600 text-sm mb-2">
                                    <!-- Diisi via JS -->
                            </select>
                            <input type="text" id="new-stage-input" class="w-full bg-slate-700 p-2 rounded border border-purple-500 text-sm hidden" placeholder="Ketik nama tahap baru...">
                        </div>
                    </div>
                    <div class="flex-grow">
                        <div class="mb-4">
                            <label for="edit-pertanyaan" class="block mb-1 text-sm font-medium">Pertanyaan</label>
                            <textarea id="edit-pertanyaan" rows="3" class="w-full bg-slate-700 p-3 rounded-lg border border-slate-600 focus:border-sky-500 outline-none" required></textarea>
                        </div>
                        <div class="grid grid-cols-1 gap-3 mb-4">
                            <div class="flex items-center gap-2"><span class="w-6 font-bold text-slate-400">A</span><input type="text" id="edit-opsiA" class="flex-1 bg-slate-700 p-2 rounded border border-slate-600 text-sm"></div>
                            <div class="flex items-center gap-2"><span class="w-6 font-bold text-slate-400">B</span><input type="text" id="edit-opsiB" class="flex-1 bg-slate-700 p-2 rounded border border-slate-600 text-sm"></div>
                            <div class="flex items-center gap-2"><span class="w-6 font-bold text-slate-400">C</span><input type="text" id="edit-opsiC" class="flex-1 bg-slate-700 p-2 rounded border border-slate-600 text-sm"></div>
                            <div class="flex items-center gap-2"><span class="w-6 font-bold text-slate-400">D</span><input type="text" id="edit-opsiD" class="flex-1 bg-slate-700 p-2 rounded border border-slate-600 text-sm"></div>
                            <div class="flex items-center gap-2"><span class="w-6 font-bold text-slate-400">E</span><input type="text" id="edit-opsiE" class="flex-1 bg-slate-700 p-2 rounded border border-slate-600 text-sm"></div>
                        </div>
                        <div class="mb-2">
                            <label for="edit-jawaban-benar" class="block mb-1 text-sm font-medium text-green-400">Kunci Jawaban (Teks Lengkap)</label>
                            <input type="text" id="edit-jawaban-benar" class="w-full bg-slate-700 p-2 rounded border border-green-600 text-sm" required>
                        </div>
                    </div>
                </div>
                <div class="flex justify-end space-x-3 mt-6 border-t border-slate-700 pt-4">
                    <button type="button" id="cancel-edit-btn" class="bg-slate-600 hover:bg-slate-700 text-white font-semibold py-2 px-4 rounded-lg">Batal</button>
                    <button type="submit" class="bg-sky-600 hover:bg-sky-700 text-white font-bold py-2 px-4 rounded-lg">Simpan</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Edit Siswa -->
    <div id="edit-siswa-modal" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-slate-800 p-8 rounded-xl shadow-2xl w-full max-w-md fade-in border border-slate-600">
            <h2 class="text-2xl font-bold mb-6 text-cyan-300">Edit Siswa</h2>
            <form id="edit-siswa-form" class="space-y-4">
                <input type="hidden" id="edit-siswa-old-nis">
                <div>
                    <label class="block text-sm mb-1 text-slate-300">NIS</label>
                    <input type="text" id="edit-siswa-nis" class="w-full bg-slate-700 p-2 rounded border border-slate-600" required>
                </div>
                <div>
                    <label class="block text-sm mb-1 text-slate-300">Nama Lengkap</label>
                    <input type="text" id="edit-siswa-nama" class="w-full bg-slate-700 p-2 rounded border border-slate-600" required>
                </div>
                <div>
                    <label class="block text-sm mb-1 text-slate-300">Kelas</label>
                    <input type="text" id="edit-siswa-kelas" class="w-full bg-slate-700 p-2 rounded border border-slate-600" placeholder="10A, 11 IPA 1, dll" required>
                </div>
                <div>
                    <label class="block text-sm mb-1 text-slate-300">Password (Absen)</label>
                    <input type="text" id="edit-siswa-password" class="w-full bg-slate-700 p-2 rounded border border-slate-600" required>
                </div>
                <div class="flex justify-end gap-3 pt-4">
                    <button type="button" onclick="document.getElementById('edit-siswa-modal').classList.add('hidden')" class="px-4 py-2 bg-slate-600 rounded text-white">Batal</button>
                    <button type="submit" class="px-6 py-2 bg-sky-600 rounded text-white font-bold">Simpan</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Import Soal -->
    <div id="import-soal-modal" class="fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-slate-800 p-6 rounded-xl w-full max-w-4xl h-[85vh] flex flex-col border border-slate-600 shadow-2xl fade-in">
            <div class="flex justify-between items-center mb-4 pb-4 border-b border-slate-700">
                <div>
                    <h2 class="text-xl font-bold text-purple-400">Ambil Soal dari Tahap Lain</h2>
                    <p class="text-sm text-slate-400">Menyalin soal ke: <span id="import-target-label" class="font-bold text-white">...</span></p>
                </div>
                <button onclick="document.getElementById('import-soal-modal').classList.add('hidden')" class="text-slate-400 hover:text-white">✕</button>
            </div>
            
            <div class="flex justify-between items-center mb-2 px-1">
                <p class="text-sm text-slate-400">Pilih soal yang ingin digunakan kembali:</p>
                <div class="text-sm flex items-center gap-2">
                    <input type="checkbox" id="select-all-import" class="rounded bg-slate-700 border-slate-600 text-purple-600 focus:ring-purple-500 cursor-pointer">
                    <label for="select-all-import" class="cursor-pointer">Pilih Semua</label>
                </div>
            </div>

            <div id="import-list" class="flex-1 overflow-y-auto space-y-2 pr-2 mb-4 bg-slate-900 p-4 rounded border border-slate-700 custom-scrollbar">
                <!-- List soal akan muncul di sini -->
            </div>
            
            <div class="flex justify-between items-center pt-4 border-t border-slate-700">
                <span id="import-count-label" class="text-sm text-slate-400">0 soal dipilih</span>
                <div class="flex gap-3">
                    <button onclick="document.getElementById('import-soal-modal').classList.add('hidden')" class="px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded text-white text-sm">Batal</button>
                    <button id="btn-execute-import" class="px-6 py-2 bg-purple-600 hover:bg-purple-700 rounded text-white font-bold text-sm disabled:opacity-50 disabled:cursor-not-allowed">Salin Soal</button>
                </div>
            </div>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const SUPABASE_URL = 'https://mtadhiyfducemvckpnkb.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im10YWRoaXlmZHVjZW12Y2twbmtiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgxNjAwMjcsImV4cCI6MjA3MzczNjAyN30.BbjPW_FDSVN_cpf6uf3xXfZnl0fKgYi2rs-m8ytBWkk';
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    
    let currentAdmin = null;
    let mataPelajaranList = [];
    let importableQuestions = [];
    let questionStageMap = {}; 
    let availableStages = new Set(['ujian', 'latihan']);

    // UI REFERENCES
    const customModalEl = document.getElementById('custom-modal');
    const modalTitleEl = document.getElementById('modal-title');
    const modalMessageEl = document.getElementById('modal-message');
    const modalButtonsEl = document.getElementById('modal-buttons');

    // FUNGSI UTILITY UI
    const showPage = (pageName) => { document.querySelectorAll('[data-page]').forEach(p => p.classList.remove('active')); document.querySelector(`[data-page="${pageName}"]`).classList.add('active'); };
    const showView = (viewName) => { document.querySelectorAll('[data-view]').forEach(v => v.classList.remove('active')); document.querySelector(`[data-view="${viewName}"]`).classList.add('active'); document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active')); document.querySelector(`.nav-btn[data-target="${viewName}"]`).classList.add('active'); };
    
    const showModal = (title, message, buttons) => {
        modalTitleEl.textContent = title;
        modalMessageEl.textContent = message;
        modalButtonsEl.innerHTML = '';
        buttons.forEach(btnInfo => {
            const button = document.createElement('button');
            button.textContent = btnInfo.text;
            button.className = btnInfo.class;
            button.onclick = () => { hideModal(); if (btnInfo.onClick) btnInfo.onClick(); };
            modalButtonsEl.appendChild(button);
        });
        customModalEl.classList.remove('hidden');
        customModalEl.classList.add('flex');
    };
    const hideModal = () => { customModalEl.classList.add('hidden'); customModalEl.classList.remove('flex'); };

    // AUTH
    async function handleLogin(e) { 
        e.preventDefault(); 
        const username = document.getElementById('username').value; 
        const password = document.getElementById('admin-password').value; 
        const errorEl = document.getElementById('admin-login-error'); 
        const btn = document.getElementById('login-submit-btn');
        
        errorEl.textContent = '';
        btn.disabled = true;
        btn.textContent = 'Memproses...';

        try {
            const { data, error } = await supabaseClient.from('admin').select('*').eq('username', username).eq('password', password).limit(1); 
            if (error) { throw error; }
            if (data && data.length > 0) { 
                currentAdmin = data[0]; 
                sessionStorage.setItem('adminUser', JSON.stringify(currentAdmin)); 
                showPage('dashboard'); 
                loadInitialData(); 
            } else { 
                errorEl.textContent = 'Username atau password salah.'; 
            }
        } catch (err) {
            console.error("Login Error:", err);
            errorEl.textContent = 'Gagal terhubung ke server. Periksa internet.';
        } finally {
            btn.disabled = false;
            btn.textContent = 'Masuk';
        }
    }
    
    function handleLogout() { currentAdmin = null; sessionStorage.removeItem('adminUser'); showPage('login'); }
    function checkSession() { const adminData = sessionStorage.getItem('adminUser'); if (adminData) { currentAdmin = JSON.parse(adminData); showPage('dashboard'); loadInitialData(); } }

    // DATA LOADING
    async function loadInitialData() {
        const refreshBtn = document.getElementById('refresh-data-btn');
        refreshBtn.querySelector('span').textContent = 'Memuat...'; refreshBtn.disabled = true;
        await fetchMataPelajaran();
        const { data: allQuestions } = await supabaseClient.from('soal_ujian').select('id, jenis_soal');
        if(allQuestions) {
            allQuestions.forEach(q => { 
                const stage = q.jenis_soal || 'ujian';
                questionStageMap[q.id] = stage; 
                availableStages.add(stage);
            });
        }
        updateStageDropdowns();
        await Promise.all([ fetchConfig(), fetchAndRenderSiswa(), fetchAndRenderSoal(), fetchAndRenderHasil(), fetchAndRenderHasilLatihan() ]); 
        refreshBtn.querySelector('span').textContent = 'Refresh Data'; refreshBtn.disabled = false;
    }
    
    function updateStageDropdowns() {
        const filterEl = document.getElementById('filter-jenis-soal');
        const editEl = document.getElementById('edit-jenis-soal');
        const configEl = document.getElementById('config-stage');
        const filterHasilEl = document.getElementById('filter-hasil-jenis');
        const currentFilterVal = filterEl.value;

        filterEl.innerHTML = ''; editEl.innerHTML = ''; configEl.innerHTML = ''; 
        filterHasilEl.innerHTML = '<option value="all">Semua Tahap</option>';

        const sortedStages = Array.from(availableStages).sort();
        sortedStages.forEach(stage => {
            let label = stage === 'ujian' ? 'Tahap 1 (Awal)' : stage.replace(/_/g, ' ').toUpperCase();
            filterEl.add(new Option(label, stage));
            editEl.add(new Option(label, stage));
            configEl.add(new Option(label, stage));
            filterHasilEl.add(new Option(label, stage));
        });

        const createNewOpt = new Option("➕ Buat Tahap Baru...", "new_custom_stage");
        createNewOpt.style.fontWeight = "bold"; createNewOpt.style.color = "#4ade80";
        editEl.add(createNewOpt);
        const createNewOptConfig = new Option("➕ Buat Tahap Baru...", "new_custom_stage");
        createNewOptConfig.style.fontWeight = "bold"; createNewOptConfig.style.color = "#4ade80";
        configEl.add(createNewOptConfig);

        if(currentFilterVal && Array.from(filterEl.options).some(o => o.value === currentFilterVal)) filterEl.value = currentFilterVal;
    }

    async function fetchMataPelajaran() {
        const { data } = await supabaseClient.from('mata_pelajaran').select('id, nama_mapel');
        if (data) {
            mataPelajaranList = data;
            ['filter-mapel', 'filter-hasil-mapel', 'filter-siswa-mapel', 'filter-latihan-mapel', 'edit-mapel', 'config-mapel'].forEach(id => {
                const selectEl = document.getElementById(id);
                if(!selectEl) return;
                const isEdit = id === 'edit-mapel' || id === 'config-mapel';
                const isSiswa = id === 'filter-siswa-mapel';
                selectEl.innerHTML = (!isEdit && !isSiswa) ? '<option value="all">Semua Mata Pelajaran</option>' : '';
                data.forEach(mapel => {
                    const opt = document.createElement('option');
                    opt.value = mapel.id;
                    opt.textContent = mapel.nama_mapel;
                    selectEl.appendChild(opt);
                });
            });
        }
    }

    // --- PUBLIKASI UJIAN ---
    async function fetchConfig() {
        const { data } = await supabaseClient.from('pengaturan_ujian').select('*, mata_pelajaran(nama_mapel)').order('id', {ascending:false});
        const tbody = document.getElementById('config-table-body');
        if(!data || data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="p-8 text-center text-slate-500">Belum ada pengaturan publikasi.</td></tr>';
            return;
        }
        tbody.innerHTML = data.map(c => {
            const statusClass = c.is_active ? 'bg-green-900 text-green-300 border border-green-700' : 'bg-slate-700 text-slate-400 border border-slate-600';
            const statusText = c.is_active ? 'AKTIF' : 'DRAFT';
            const stageLabel = c.jenis_soal === 'ujian' ? 'Tahap 1' : c.jenis_soal.replace(/_/g, ' ').toUpperCase();
            return `<tr class="border-b border-slate-700 hover:bg-slate-750"><td class="p-4 font-medium">${c.mata_pelajaran?.nama_mapel}</td><td class="p-4"><span class="bg-slate-700 px-2 py-1 rounded text-xs border border-slate-600">${stageLabel}</span></td><td class="p-4 font-mono text-sm text-yellow-400">${c.kelas_target || 'Semua'}</td><td class="p-4 text-sm">${c.durasi_menit} Menit</td><td class="p-4"><span class="px-3 py-1 rounded text-xs font-bold ${statusClass}">${statusText}</span></td><td class="p-4 text-right"><button onclick="editConfig(${c.id})" class="text-sky-400 hover:text-white mr-3 font-medium">Edit</button><button onclick="deleteConfig(${c.id})" class="text-red-400 hover:text-white font-medium">Hapus</button></td></tr>`;
        }).join('');
    }

    window.editConfig = async (id) => {
        const { data } = await supabaseClient.from('pengaturan_ujian').select('*').eq('id', id).limit(1);
        if(!data || data.length === 0) return;
        const config = data[0];
        document.getElementById('config-id').value = config.id;
        document.getElementById('config-mapel').value = config.mapel_id;
        const stageSel = document.getElementById('config-stage');
        if (!Array.from(stageSel.options).some(o=>o.value === config.jenis_soal)) { availableStages.add(config.jenis_soal); updateStageDropdowns(); }
        stageSel.value = config.jenis_soal;
        document.getElementById('config-kelas').value = config.kelas_target;
        document.getElementById('config-durasi').value = config.durasi_menit;
        document.getElementById('config-active').checked = config.is_active;
        document.getElementById('config-modal').classList.remove('hidden');
        document.getElementById('config-modal').classList.add('flex');
    };

    window.deleteConfig = (id) => {
        showModal('Hapus Pengaturan?', 'Siswa tidak akan bisa melihat ujian ini lagi.', [{text:'Batal', class:'bg-slate-600 text-white py-2 px-4 rounded'}, {text:'Hapus', class:'bg-red-600 text-white py-2 px-4 rounded', onClick: async () => { await supabaseClient.from('pengaturan_ujian').delete().eq('id', id); fetchConfig(); }}]);
    };

    document.getElementById('btn-add-config').addEventListener('click', () => {
        document.getElementById('config-form').reset();
        document.getElementById('config-id').value = '';
        document.getElementById('config-modal').classList.remove('hidden');
        document.getElementById('config-modal').classList.add('flex');
    });

    document.getElementById('config-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const id = document.getElementById('config-id').value;
        const mapel = document.getElementById('config-mapel').value;
        let stage = document.getElementById('config-stage').value;
        const kelas = document.getElementById('config-kelas').value;
        const durasi = document.getElementById('config-durasi').value;
        const active = document.getElementById('config-active').checked;
        if (stage === 'new_custom_stage') {
            const raw = document.getElementById('config-stage-new').value.trim();
            if(!raw) return alert("Nama tahap wajib diisi.");
            stage = raw.replace(/\s+/g, '_').toLowerCase();
            availableStages.add(stage); updateStageDropdowns();
        }
        const payload = { mapel_id: mapel, jenis_soal: stage, kelas_target: kelas, durasi_menit: durasi, is_active: active };
        let error;
        if(id) { const res = await supabaseClient.from('pengaturan_ujian').update(payload).eq('id', id); error = res.error; } else { const res = await supabaseClient.from('pengaturan_ujian').upsert([payload], { onConflict: 'mapel_id, jenis_soal' }); error = res.error; }
        if(error) alert('Gagal: ' + error.message); else { document.getElementById('config-modal').classList.add('hidden'); document.getElementById('config-modal').classList.remove('flex'); fetchConfig(); }
    });

    ['edit-jenis-soal', 'config-stage'].forEach(id => {
        document.getElementById(id).addEventListener('change', e => {
            const input = e.target.nextElementSibling;
            if(input && input.tagName === 'INPUT') { if(e.target.value === 'new_custom_stage') { input.classList.remove('hidden'); input.required = true; } else { input.classList.add('hidden'); input.required = false; } }
        });
    });

    // --- SISWA ---
    async function fetchAndRenderSiswa() {
        const { data: siswaList } = await supabaseClient.from('siswa').select('*').order('nis');
        const filterMapelId = parseInt(document.getElementById('filter-siswa-mapel').value) || (mataPelajaranList[0]?.id);
        const { data: hasilData } = await supabaseClient.from('hasil_ujian').select('nis_siswa, mapel_id');
        if (siswaList) {
            const tbody = document.getElementById('siswa-table-body');
            tbody.innerHTML = siswaList.map(siswa => {
                const done = (hasilData || []).some(h => h.nis_siswa === siswa.nis && h.mapel_id === filterMapelId);
                const kelasText = siswa.kelas ? `<span class="bg-purple-900 text-purple-200 px-2 py-1 rounded text-xs border border-purple-700">${siswa.kelas}</span>` : '<span class="text-slate-500 italic">-</span>';
                return `<tr class="border-b border-slate-700 hover:bg-slate-800"><td class="p-3 w-4"><input type="checkbox" class="siswa-checkbox" data-nis="${siswa.nis}"></td><td class="p-3 font-mono text-slate-300">${siswa.nis}</td><td class="p-3 font-medium">${siswa.nama}</td><td class="p-3">${kelasText}</td><td class="p-3"><span class="px-2 py-1 rounded text-xs ${done ? 'bg-green-900 text-green-300' : 'bg-yellow-900 text-yellow-300'}">${done ? 'Selesai' : 'Belum'}</span></td><td class="p-3 flex gap-2 text-right"><button onclick="editSiswa('${siswa.nis}')" class="text-sky-400 hover:text-white text-sm font-medium mr-2">Edit</button>${done ? `<button class="text-green-400 hover:text-white text-sm font-medium mr-2 reset-siswa-btn" data-nis="${siswa.nis}" data-mapel="${filterMapelId}">Reset</button>` : ''}<button class="text-red-400 hover:text-white text-sm font-medium delete-siswa-btn" data-nis="${siswa.nis}">Hapus</button></td></tr>`;
            }).join('');
        }
    }
    
    // --- NEW: ROBUST DELETE SISWA LOGIC ---
    const deleteSiswa = async (nis) => {
        showModal('Konfirmasi Hapus', `Yakin hapus siswa NIS ${nis}? Semua riwayat nilai akan ikut terhapus.`, [
            { text: 'Batal', class: 'bg-slate-600 text-white py-2 px-4 rounded' },
            { text: 'Hapus Permanen', class: 'bg-red-600 text-white py-2 px-4 rounded', onClick: async () => {
                // Manual Cascade
                const { error: err1 } = await supabaseClient.from('hasil_ujian').delete().eq('nis_siswa', nis);
                if (err1) { alert('Gagal hapus riwayat ujian: ' + err1.message); return; }
                
                const { error: err2 } = await supabaseClient.from('hasil_latihan').delete().eq('nis_siswa', nis);
                if (err2) { alert('Gagal hapus riwayat latihan: ' + err2.message); return; }

                const { error: err3 } = await supabaseClient.from('siswa').delete().eq('nis', nis);
                if (err3) { alert('Gagal hapus siswa: ' + err3.message); } 
                else { loadInitialData(); }
            }}
        ]);
    };

    // --- NEW: ROBUST BULK DELETE SISWA ---
    document.getElementById('delete-selected-siswa-btn').addEventListener('click', () => {
        const nisToDelete = Array.from(document.querySelectorAll('.siswa-checkbox:checked')).map(cb => cb.dataset.nis);
        if (nisToDelete.length === 0) return;
        
        showModal('Konfirmasi Hapus Massal', `Yakin hapus ${nisToDelete.length} siswa terpilih?`, [ 
            { text: 'Batal', class: 'bg-slate-600 hover:bg-slate-700 text-white font-semibold py-2 px-4 rounded-lg' }, 
            { text: 'Ya, Hapus', class: 'bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg', onClick: async () => { 
                // Manual Cascade Bulk
                await supabaseClient.from('hasil_ujian').delete().in('nis_siswa', nisToDelete);
                await supabaseClient.from('hasil_latihan').delete().in('nis_siswa', nisToDelete);
                
                const { error } = await supabaseClient.from('siswa').delete().in('nis', nisToDelete); 
                
                if (error) { alert("Gagal menghapus: " + error.message); }
                else {
                    fetchAndRenderSiswa(); 
                    document.getElementById('select-all-siswa').checked = false;
                    document.getElementById('delete-selected-siswa-btn').classList.add('hidden');
                }
            }} 
        ]);
    });

    window.editSiswa = async (nis) => {
        const { data } = await supabaseClient.from('siswa').select('*').eq('nis', nis).limit(1);
        if (!data || data.length === 0) return;
        const s = data[0];
        document.getElementById('edit-siswa-old-nis').value = s.nis; 
        document.getElementById('edit-siswa-nis').value = s.nis;
        document.getElementById('edit-siswa-nama').value = s.nama;
        document.getElementById('edit-siswa-kelas').value = s.kelas || '';
        document.getElementById('edit-siswa-password').value = s.password;
        document.getElementById('edit-siswa-modal').classList.remove('hidden');
        document.getElementById('edit-siswa-modal').classList.add('flex');
    };
    document.getElementById('edit-siswa-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const oldNis = document.getElementById('edit-siswa-old-nis').value;
        const newNis = document.getElementById('edit-siswa-nis').value;
        const nama = document.getElementById('edit-siswa-nama').value;
        const kelas = document.getElementById('edit-siswa-kelas').value;
        const password = document.getElementById('edit-siswa-password').value;
        const { error } = await supabaseClient.from('siswa').update({ nis: newNis, nama, kelas, password }).eq('nis', oldNis);
        if(error) alert('Gagal update siswa: ' + error.message); else { document.getElementById('edit-siswa-modal').classList.add('hidden'); document.getElementById('edit-siswa-modal').classList.remove('flex'); fetchAndRenderSiswa(); }
    });

    // --- SOAL ---
    async function fetchAndRenderSoal() {
        const mapel = document.getElementById('filter-mapel').value;
        const stage = document.getElementById('filter-jenis-soal').value;
        let query = supabaseClient.from('soal_ujian').select('*').order('id', {ascending:false});
        if(mapel !== 'all') query = query.eq('mapel_id', mapel);
        if(stage !== 'all') query = query.eq('jenis_soal', stage);
        const { data } = await query;
        const tbody = document.getElementById('soal-table-body');
        const empty = document.getElementById('empty-state-soal');
        if(data && data.length > 0) {
            tbody.parentElement.classList.remove('hidden');
            empty.classList.add('hidden');
            tbody.innerHTML = data.map(q => {
                const mapelName = mataPelajaranList.find(m => m.id === q.mapel_id)?.nama_mapel || '?';
                return `<tr class="border-b border-slate-700 hover:bg-slate-800 group"><td class="p-3 w-4"><input type="checkbox" class="soal-checkbox" data-id="${q.id}"></td><td class="p-3 text-xs text-slate-500">${q.id}</td><td class="p-3 text-xs text-slate-300">${mapelName}</td><td class="p-3"><span class="bg-blue-900 text-blue-200 text-[10px] px-2 py-1 rounded uppercase">${q.jenis_soal || 'Ujian'}</span></td><td class="p-3 max-w-xs truncate text-slate-200">${q.pertanyaan}</td><td class="p-3 text-center text-xs">${q.url_gambar ? '✅' : '-'}</td><td class="p-3 text-center font-bold text-green-500">${q.jawaban_benar}</td><td class="p-3 flex gap-2 opacity-50 group-hover:opacity-100"><button class="text-sky-400 hover:text-sky-300 edit-soal-btn" data-id="${q.id}">Edit</button><button class="text-red-400 hover:text-red-300 delete-soal-btn" data-id="${q.id}">Hapus</button></td></tr>`;
            }).join('');
        } else {
            tbody.parentElement.classList.add('hidden');
            empty.classList.remove('hidden');
        }
    }
    
    // --- EVENT LISTENER DELEGATION ---
    document.getElementById('siswa-table-body').addEventListener('click', e => {
        // Handle delete single
        if (e.target.classList.contains('delete-siswa-btn')) {
            const nis = e.target.dataset.nis;
            deleteSiswa(nis);
        }
        // Handle reset single
        if (e.target.classList.contains('reset-siswa-btn')) {
            showModal('Reset Ujian', 'Yakin reset ujian siswa ini?', [{text:'Batal',class:'bg-slate-600 py-2 px-4 rounded text-white'},{text:'Ya',class:'bg-green-600 py-2 px-4 rounded text-white', onClick:async()=>{
                await supabaseClient.from('hasil_ujian').delete().eq('nis_siswa', e.target.dataset.nis).eq('mapel_id', e.target.dataset.mapel); loadInitialData();
            }}]);
        }
    });

    document.getElementById('soal-table-body').addEventListener('click', e => {
        const btn = e.target.closest('button');
        if (!btn) return;
        if (btn.classList.contains('delete-soal-btn')) {
             // Helper delete for soal is simpler (no cascade needed usually)
             showModal('Konfirmasi Hapus', `Hapus soal ID ${btn.dataset.id}?`, [{ text: 'Batal', class: 'bg-slate-600 text-white py-2 px-4 rounded' }, { text: 'Hapus', class: 'bg-red-600 text-white py-2 px-4 rounded', onClick: async () => {
                await supabaseClient.from('soal_ujian').delete().eq('id', btn.dataset.id); loadInitialData();
            }}]);
        }
        if (btn.classList.contains('edit-soal-btn')) {
             openEditSoalModal(btn.dataset.id);
        }
    });
    
    // BULK DELETE SOAL
    document.getElementById('delete-selected-soal-btn').addEventListener('click', () => {
        const idsToDelete = Array.from(document.querySelectorAll('.soal-checkbox:checked')).map(cb => cb.dataset.id);
        if (idsToDelete.length === 0) return;
        showModal('Konfirmasi Hapus Massal', `Yakin hapus ${idsToDelete.length} soal terpilih?`, [ 
            { text: 'Batal', class: 'bg-slate-600 hover:bg-slate-700 text-white font-semibold py-2 px-4 rounded-lg' }, 
            { text: 'Ya, Hapus', class: 'bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg', onClick: async () => { 
                const { error } = await supabaseClient.from('soal_ujian').delete().in('id', idsToDelete); 
                if (error) { alert("Gagal menghapus: " + error.message); }
                else {
                    fetchAndRenderSoal(); 
                    document.getElementById('select-all-soal').checked = false;
                    document.getElementById('delete-selected-soal-btn').classList.add('hidden');
                }
            }} 
        ]);
    });
    
    document.getElementById('btn-open-create-soal').addEventListener('click', () => { document.getElementById('edit-soal-form').reset(); document.getElementById('edit-soal-id').value = ''; document.getElementById('form-title').textContent = "Buat Soal Baru"; document.getElementById('edit-soal-modal').classList.remove('hidden'); document.getElementById('edit-soal-modal').classList.add('flex'); });
    
    window.editSoal = async (id) => { /* ... same logic ... */ }; 
    const openEditSoalModal = async (id = null) => {
        const { data } = await supabaseClient.from('soal_ujian').select('*').eq('id', id).limit(1);
        if(!data || data.length === 0) return;
        const soalData = data[0];
        document.getElementById('edit-soal-id').value = soalData.id;
        document.getElementById('edit-soal-image-path').value = soalData.url_gambar || '';
        document.getElementById('edit-mapel').value = soalData.mapel_id;
        const stageSel = document.getElementById('edit-jenis-soal');
        if(!Array.from(stageSel.options).some(o=>o.value === soalData.jenis_soal)) { availableStages.add(soalData.jenis_soal); updateStageDropdowns(); }
        stageSel.value = soalData.jenis_soal;
        document.getElementById('edit-pertanyaan').value = soalData.pertanyaan;
        ['A','B','C','D','E'].forEach((c, i) => document.getElementById(`edit-opsi${c}`).value = soalData.pilihan[i] || '');
        document.getElementById('edit-jawaban-benar').value = soalData.jawaban_benar;
        document.getElementById('image-preview').src = soalData.url_gambar || '';
        document.getElementById('form-title').textContent = "Edit Soal";
        document.getElementById('edit-soal-modal').classList.remove('hidden');
        document.getElementById('edit-soal-modal').classList.add('flex');
    };

    document.getElementById('edit-soal-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const id = document.getElementById('edit-soal-id').value;
        const mapel = document.getElementById('edit-mapel').value;
        let stage = document.getElementById('edit-jenis-soal').value;
        if(stage === 'new_custom_stage') { stage = document.getElementById('new-stage-input').value.trim().replace(/\s+/g, '_').toLowerCase(); availableStages.add(stage); updateStageDropdowns(); }
        const fileInput = document.getElementById('image-upload');
        let url = document.getElementById('edit-soal-image-path').value;
        if (fileInput.files.length > 0) {
            const file = fileInput.files[0];
            const path = `soal-${Date.now()}`;
            const { error: upErr } = await supabaseClient.storage.from('gambar_soal').upload(path, file);
            if (!upErr) url = supabaseClient.storage.from('gambar_soal').getPublicUrl(path).data.publicUrl;
        }
        const payload = { mapel_id: mapel, jenis_soal: stage, pertanyaan: document.getElementById('edit-pertanyaan').value, pilihan: ['A','B','C','D','E'].map(c => document.getElementById(`edit-opsi${c}`).value).filter(Boolean), jawaban_benar: document.getElementById('edit-jawaban-benar').value, url_gambar: url };
        if(id) await supabaseClient.from('soal_ujian').update(payload).eq('id', id); else await supabaseClient.from('soal_ujian').insert([payload]);
        document.getElementById('edit-soal-modal').classList.add('hidden'); document.getElementById('edit-soal-modal').classList.remove('flex'); fetchAndRenderSoal();
    });

    document.getElementById('filter-mapel').addEventListener('change', fetchAndRenderSoal);
    document.getElementById('filter-jenis-soal').addEventListener('change', fetchAndRenderSoal);

    // --- HASIL & ANALITIK ---
    async function fetchAndRenderHasil() {
        const filterMapelId = document.getElementById('filter-hasil-mapel').value;
        const filterStage = document.getElementById('filter-hasil-jenis').value; 
        let query = supabaseClient.from('hasil_ujian').select('*, siswa(nama), mata_pelajaran(nama_mapel)').order('waktu_pengerjaan', { ascending: false });
        if (filterMapelId && filterMapelId !== 'all') query = query.eq('mapel_id', filterMapelId);
        const { data } = await query;
        if (data) {
            const filteredData = data.filter(h => {
                if (filterStage === 'all') return true;
                const firstKey = Object.keys(h.jawaban_siswa)[0]; 
                if (!firstKey) return false;
                const qId = parseInt(firstKey.split('-')[1]);
                const detectedStage = questionStageMap[qId] || 'ujian'; 
                return detectedStage === filterStage;
            });
            document.getElementById('hasil-table-body').innerHTML = filteredData.map(h => {
                let stageLabel = 'Tahap 1';
                const firstKey = Object.keys(h.jawaban_siswa)[0];
                if(firstKey) {
                    const qId = parseInt(firstKey.split('-')[1]);
                    const detectedStage = questionStageMap[qId];
                    stageLabel = detectedStage === 'ujian' ? 'Tahap 1' : detectedStage.replace(/_/g, ' ').toUpperCase();
                }
                return `<tr class="border-b border-slate-700"><td class="p-3 text-xs text-slate-400">${new Date(h.waktu_pengerjaan).toLocaleString('id-ID')}</td><td class="p-3 font-mono text-sm">${h.nis_siswa}</td><td class="p-3 font-medium">${h.siswa ? h.siswa.nama : 'N/A'}</td><td class="p-3 text-sm">${h.mata_pelajaran ? h.mata_pelajaran.nama_mapel : 'N/A'}</td><td class="p-3"><span class="text-xs bg-slate-700 px-2 py-1 rounded border border-slate-600">${stageLabel}</span></td><td class="p-3 font-bold ${h.skor_akhir >= 75 ? 'text-green-400' : 'text-red-400'}">${h.skor_akhir}</td><td class="p-3 text-right"><button onclick="handleDeleteHasil(${h.id})" class="text-red-500 hover:text-red-400">✕</button></td></tr>`;
            }).join('');
        }
    }
    window.handleDeleteHasil = async (id) => { if(confirm('Hapus riwayat nilai ini?')) { await supabaseClient.from('hasil_ujian').delete().eq('id', id); fetchAndRenderHasil(); } };
    async function fetchAndRenderHasilLatihan() { const filterMapelId = document.getElementById('filter-latihan-mapel').value; let query = supabaseClient.from('hasil_latihan').select('*, siswa(nama), mata_pelajaran(nama_mapel)'); if (filterMapelId && filterMapelId !== 'all') query = query.eq('mapel_id', filterMapelId); const { data } = await query; if (!data) return; const processed = {}; data.forEach(item => { const key = `${item.nis_siswa}-${item.mapel_id}`; if (!processed[key]) processed[key] = { nis: item.nis_siswa, nama: item.siswa?.nama || 'N/A', mapel: item.mata_pelajaran?.nama_mapel || 'N/A', percobaan: {} }; processed[key].percobaan[item.nomor_percobaan] = item.skor; }); document.getElementById('latihan-table-body').innerHTML = Object.values(processed).map(d => { const keys = Object.keys(d.percobaan).map(Number).sort((a,b)=>a-b); const awal = d.percobaan[keys[0]] || 0; const akhir = d.percobaan[keys[keys.length-1]] || 0; return `<tr class="border-b border-slate-700"><td class="p-3">${d.nis}</td><td class="p-3">${d.nama}</td><td class="p-3">${d.mapel}</td><td class="p-3">${awal}</td><td class="p-3 text-sky-400 font-bold">${akhir}</td><td class="p-3">${((awal+akhir)/2).toFixed(1)}</td></tr>`; }).join(''); }
    async function fetchAnalitik() {
        const { data: hasilData } = await supabaseClient.from('hasil_ujian').select('skor_akhir, mapel_id, jawaban_siswa');
        const { data: soalData } = await supabaseClient.from('soal_ujian').select('id, pertanyaan, jawaban_benar');
        if (!hasilData || !soalData) return;
        const scoresByMapel = {};
        hasilData.forEach(hasil => { if (!scoresByMapel[hasil.mapel_id]) scoresByMapel[hasil.mapel_id] = { totalScore: 0, count: 0 }; scoresByMapel[hasil.mapel_id].totalScore += hasil.skor_akhir; scoresByMapel[hasil.mapel_id].count++; });
        const chartLabels = []; const chartData = [];
        for (const mapelId in scoresByMapel) { const mapel = mataPelajaranList.find(m => m.id == mapelId); if (mapel) { chartLabels.push(mapel.nama_mapel); chartData.push(scoresByMapel[mapelId].totalScore / scoresByMapel[mapelId].count); } }
        const ctx = document.getElementById('average-score-chart'); new Chart(ctx, { type: 'bar', data: { labels: chartLabels, datasets: [{ label:'Rata-rata Skor', data: chartData, backgroundColor: 'rgba(56, 189, 248, 0.6)', borderColor: 'rgba(56, 189, 248, 1)', borderWidth: 1 }] }, options: { scales: { y: { beginAtZero: true, max: 100 } }, plugins: { legend: { display: false } } } });
        const incorrectCounts = {};
        hasilData.forEach(hasil => { for (const questionKey in hasil.jawaban_siswa) { const questionId = parseInt(questionKey.split('-')[1]); const siswaAnswer = hasil.jawaban_siswa[questionKey]; const correctAnswer = soalData.find(s => s.id === questionId)?.jawaban_benar; if (correctAnswer && siswaAnswer !== correctAnswer) { if (!incorrectCounts[questionId]) incorrectCounts[questionId] = 0; incorrectCounts[questionId]++; } } });
        const sortedQuestions = Object.entries(incorrectCounts).sort(([, a], [, b]) => b - a).slice(0, 5);
        document.getElementById('difficult-questions-list').innerHTML = sortedQuestions.map(([qId, count]) => { const soal = soalData.find(s => s.id == qId); return `<div class="bg-slate-900 p-3 rounded-lg"><p class="text-sm text-slate-300 truncate">${soal ? soal.pertanyaan : `Soal ID: ${qId}`}</p><p class="text-xs text-red-400 font-semibold">${count} kali salah</p></div>`; }).join('') || '<p class="text-slate-500">Belum ada data.</p>';
    }

    // EVENT HANDLERS
    document.getElementById('admin-login-form').addEventListener('submit', handleLogin);
    document.getElementById('logout-btn').addEventListener('click', handleLogout);
    document.getElementById('refresh-data-btn').addEventListener('click', loadInitialData);
    document.querySelectorAll('.nav-btn').forEach(btn => btn.addEventListener('click', () => showView(btn.dataset.target)));
    document.getElementById('filter-siswa-mapel').addEventListener('change', fetchAndRenderSiswa);
    document.getElementById('filter-hasil-mapel').addEventListener('change', fetchAndRenderHasil);
    document.getElementById('filter-hasil-jenis').addEventListener('change', fetchAndRenderHasil);
    document.getElementById('filter-latihan-mapel').addEventListener('change', fetchAndRenderHasilLatihan);
    
    const imageUploadInput = document.getElementById('image-upload');
    const imagePreview = document.getElementById('image-preview');
    imageUploadInput.addEventListener('change', (e) => { const file = e.target.files[0]; if (file) { if (file.size > 1024 * 1024) { showModal('Error', 'Ukuran file gambar tidak boleh melebihi 1MB.', [{ text: 'OK', class: 'bg-sky-600 hover:bg-sky-700 text-white font-bold py-2 px-6 rounded-lg' }]); e.target.value = null; return; } imgFile = file; delImg = false; imagePreview.src = URL.createObjectURL(file); } });
    document.getElementById('remove-image-btn').addEventListener('click', () => { imgFile = null; delImg = true; imageUploadInput.value = ''; imagePreview.src = 'https://placehold.co/150x100/1e293b/94a3b8?text=Tidak+Ada'; });

    checkSession();
});
</script>
</body>
</html>
